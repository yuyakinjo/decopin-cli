# ハンドラー実行順序の統一的管理への移行計画

このドキュメントは、decopin-cli のハンドラー実行順序を統一的に管理するシステムへの移行計画を記載しています。

## 概要

現在、各ハンドラーの実行順序は暗黙的に実装されていますが、これを明示的で統一的な管理システムに移行します。

### 移行の目的
- ハンドラーの実行順序を一元管理
- 新しいハンドラータイプの追加を容易に
- 依存関係の明確化
- 保守性と拡張性の向上

## Phase 1: ハンドラーレジストリの実装

ハンドラーの定義と実行順序を管理する基盤を構築します。

### タスク
- [x] **Phase 1-1**: ハンドラーレジストリの型定義作成 (`src/types/handler-registry.ts`)
  - [x] `HandlerDefinition` インターフェースの定義
  - [x] `HandlerScope` 型の定義 (`'global' | 'command'`)
  - [x] `HandlerRegistryMap` 型の定義
  - [x] 実行順序の定数定義（EXECUTION_ORDER enum）

- [x] **Phase 1-2**: HANDLER_REGISTRY定数の実装
  - [x] global-error ハンドラー定義（実行順序: 0）
  - [x] env ハンドラー定義（実行順序: 100）
  - [x] version ハンドラー定義（実行順序: 200）
  - [x] middleware ハンドラー定義（実行順序: 300）
  - [x] help ハンドラー定義（実行順序: 400）
  - [x] params ハンドラー定義（実行順序: 500）
  - [x] command ハンドラー定義（実行順序: 1000）
  - [x] error ハンドラー定義（実行順序: 1100）

- [x] **Phase 1-3**: ハンドラーレジストリのテスト作成 (`test/types/handler-registry.test.ts`)
  - [x] 実行順序の昇順ソートテスト
  - [x] 依存関係の整合性チェックテスト
  - [x] 必須/オプションフラグの検証テスト
  - [x] スコープ別フィルタリングテスト

## Phase 2: スキャナーの改修

ハンドラーレジストリを使用してファイルをスキャンする仕組みに改修します。

### タスク
- [x] **Phase 2-1**: HandlerExecutorクラスの実装 (`src/core/handler-executor.ts`)
  - [x] コンストラクタでレジストリを初期化
  - [x] `getExecutionOrder(scope)` メソッドの実装
  - [x] `validateDependencies(availableHandlers)` メソッドの実装
  - [x] `buildContext(initialContext, handlers)` メソッドの実装
  - [x] `executeHandler(definition, handler, context)` プライベートメソッドの実装

- [x] **Phase 2-2**: Scanner改修 - 統一的なハンドラー管理への移行
  - [x] ハンドラーレジストリのインポートと初期化
  - [x] 既存の個別スキャンロジックを統一化
  - [x] グローバルスコープのハンドラースキャン実装
  - [x] コマンドスコープのハンドラースキャン実装
  - [x] 後方互換性のための既存フィールド維持

- [x] **Phase 2-3**: CLIStructure型の更新 (`src/core/types.ts`)
  - [x] `handlers: Map<string, HandlerInfo>` フィールドの追加
  - [x] `HandlerInfo` インターフェースの定義
  - [x] 既存フィールドに `@deprecated` コメント追加
  - [x] 型の互換性確保

- [x] **Phase 2-4**: Scannerテストの更新 (`test/scanner/scanner.test.ts`)
  - [x] 新しいハンドラーMap構造のテスト追加
  - [x] グローバルハンドラー検出テスト
  - [x] コマンドハンドラー検出テスト
  - [x] 既存テストの動作確認

## Phase 3: ジェネレーターの改修

統一的なハンドラー管理を使用してCLIを生成する仕組みに改修します。

### タスク
- [x] **Phase 3-1**: ジェネレーターのハンドラー処理を統一化
  - [x] HandlerExecutorのインポート
  - [x] ハンドラーレジストリベースの処理に変更
  - [x] 動的インポート生成の統一化
  - [x] 実行順序に基づく処理フローの実装

- [x] **Phase 3-2**: グローバルハンドラー実行の生成ロジック実装
  - [x] `generateUnifiedGlobalHandlers` 関数の作成
  - [x] env ハンドラーの初期化処理
  - [x] version ハンドラーの初期化処理
  - [x] middleware ハンドラーの初期化処理
  - [x] global-error ハンドラーの特別処理

- [x] **Phase 3-3**: コマンドハンドラー実行の生成ロジック実装
  - [x] `generateUnifiedCommandExecution` 関数の作成
  - [x] help ハンドラーの処理
  - [x] params ハンドラーの処理と検証
  - [x] command ハンドラーの実行
  - [x] error ハンドラーのラップ処理
  - [x] コンテキストの累積的構築

- [x] **Phase 3-4**: ジェネレーターテストの更新 (`test/generator/lazy-cli-template.test.ts`)
  - [x] 生成されたコードの実行順序検証
  - [x] ハンドラー間の依存関係テスト
  - [x] コンテキスト伝播のテスト
  - [x] エラーハンドリングのテスト

## Phase 4: 移行と統合

既存のコードを新しいシステムに移行し、全体の統合テストを実施します。

### タスク
- [x] **Phase 4-1**: 既存のハンドラー処理コードの移行
  - [x] 個別のハンドラー処理を削除
  - [x] 統一的な処理への置き換え
  - [x] 非推奨警告の追加
  - [x] 移行ガイドの作成

- [x] **Phase 4-2**: 統合テストの実施
  - [x] すべてのハンドラーを含むCLIのビルドテスト
  - [x] 実行順序の統合テスト
  - [x] 依存関係のある複雑なケースのテスト
  - [x] パフォーマンステスト（起動時間の計測）
  - [x] 後方互換性テスト

- [x] **Phase 4-3**: ドキュメントの更新
  - [x] CLAUDE.md にハンドラーレジストリの説明追加
  - [x] README.md の「Architecture」セクション更新
  - [x] app/README.md の実装状況を更新
  - [x] 新しいハンドラー追加のガイド作成

## 完了基準

### Phase 1 完了基準
- [x] すべてのハンドラー定義がレジストリに含まれている
- [x] テストがすべてパスしている
- [x] 型定義が正しくエクスポートされている

### Phase 2 完了基準
- [x] Scannerが新しい方式で動作している
- [x] 既存の機能に影響がない
- [x] テストカバレッジが維持されている

### Phase 3 完了基準
- [x] 生成されたCLIが正しく動作する
- [x] 実行順序が意図通りである
- [x] パフォーマンスの劣化がない

### Phase 4 完了基準
- [x] すべての統合テストがパスしている
- [x] ドキュメントが最新化されている
- [x] 移行による breaking change がない

## リスクと対策

### リスク
1. **後方互換性の破壊**: 既存のCLIが動作しなくなる可能性
   - **対策**: 段階的な移行と十分なテスト

2. **パフォーマンスの劣化**: 統一的な管理によるオーバーヘッド
   - **対策**: ベンチマークテストの実施

3. **複雑性の増加**: 新しいシステムの学習コスト
   - **対策**: 詳細なドキュメントとサンプルの提供

## スケジュール目安

- Phase 1: 1-2日
- Phase 2: 2-3日
- Phase 3: 2-3日
- Phase 4: 1-2日

合計: 6-10日（テストとレビューを含む）

## 備考

- 各フェーズは独立して実装可能
- フェーズ完了ごとにPRを作成し、レビューを実施
- 問題が発生した場合は、該当フェーズのロールバックが可能